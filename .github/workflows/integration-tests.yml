name: Server Migration Tests

on:
  push:
    branches:
      - master
      - main
      - develop
    paths:
      - 'tests/**'
      - 'ansible/**'
      - 'scripts/**/*.ps1'
      - '.github/workflows/integration-tests.yml'
  pull_request:
    paths:
      - 'tests/**'
      - 'ansible/**'
      - 'scripts/**/*.ps1'
      - '.github/workflows/integration-tests.yml'
  workflow_dispatch:
    inputs:
      suite:
        description: 'Test suite to run'
        required: false
        default: 'Integration'
        type: choice
        options:
          - Integration
          - All

jobs:
  run-tests:
    name: Run Pester Tests
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PowerShell modules
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name Pester -MinimumVersion 5.5.0 -Force -Scope CurrentUser

      - name: Execute tests
        shell: pwsh
        run: |
          $suite = if ('${{ github.event.inputs.suite }}') { '${{ github.event.inputs.suite }}' } else { 'Integration' }
          Write-Host "Running server migration tests for suite: $suite"
          Push-Location tests/scripts
          ./Invoke-Tests.ps1 -Suite $suite
          Pop-Location
          Add-Content -Path $env:GITHUB_ENV -Value "suite=$suite"

      - name: Publish summary
        if: always()
        shell: pwsh
        run: |
          Write-Host "## Server Migration Tests" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "âœ… Tests executed via Invoke-Tests.ps1" >> $env:GITHUB_STEP_SUMMARY
          $suite = if ($env:suite) { $env:suite } else { 'Integration' }
          Write-Host "Suite: $suite" >> $env:GITHUB_STEP_SUMMARY
